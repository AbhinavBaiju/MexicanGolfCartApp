{% assign is_product_page = false %}
{% if request.page_type == 'product' or template.name == 'product' %}
  {% assign is_product_page = true %}
{% endif %}

<section class="mgc-white-card-section{% if is_product_page %} mgc-white-card-section--product{% endif %}">

  <div class="booking-outer-wrapper">
    <div class="booking-container{% if is_product_page %} booking-container--product{% endif %}" data-booking-widget data-shop-domain="{{ shop.permanent_domain }}" data-api-base="/apps/rental">
      
      <!-- Booking Form Slot -->
      <div class="mgc-booking-slot">
        <!-- Add Flatpickr -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/rangePlugin.js"></script>

        <div class="gc-error-state" style="display: none;">
          <p>We are currently experiencing issues with our booking system.</p>
          <a href="/pages/contact" class="gc-submit-btn">Contact Us to Book</a>
        </div>

        {% if is_product_page and product %}
          {% assign booking_product = product %}
        {% else %}
          {% assign booking_product = block.settings.product | default: product %}
        {% endif %}
        
	        <div class="gc-grid-container{% if is_product_page %} gc-grid-container--product{% endif %}">
              {% unless is_product_page %}
	              <div class="gc-grid-col-left">
	                  <div class="gc-product-image-container" data-gc-product-image-container>
	                    <img class="gc-product-image" data-gc-product-image alt="" loading="lazy" decoding="async" style="display: none;">
	                    <div class="gc-product-image-placeholder" data-gc-product-image-placeholder>
	                      <div class="gc-product-image-placeholder-inner">
	                        <svg class="gc-product-image-placeholder-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
	                          <path d="M4 6.5A2.5 2.5 0 0 1 6.5 4h11A2.5 2.5 0 0 1 20 6.5v11A2.5 2.5 0 0 1 17.5 20h-11A2.5 2.5 0 0 1 4 17.5v-11Z" stroke="currentColor" stroke-width="1.5"/>
	                          <path d="M8 10.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" stroke="currentColor" stroke-width="1.5"/>
	                          <path d="M4.5 17l5.2-5.2a1.2 1.2 0 0 1 1.7 0L14 14.4l1.2-1.2a1.2 1.2 0 0 1 1.7 0L19.5 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
	                        </svg>
	                        <span class="gc-product-image-placeholder-text">Image coming soon</span>
	                      </div>
	                    </div>
	                  </div>
	              </div>
              {% endunless %}
	            <div class="gc-grid-col-right">
	                <form class="gc-booking-form" data-product-id="{{ booking_product.id }}" data-variant-id="{{ booking_product.selected_or_first_available_variant.id }}" data-page-context="{{ request.page_type }}">
	                
	                <div class="gc-form-grid">
                    {% if is_product_page and booking_product %}
                      <div class="gc-product-summary">
                        <h2 class="gc-product-summary-title">{{ booking_product.title }}</h2>
                        <p class="gc-product-summary-price">{{ booking_product.selected_or_first_available_variant.price | money }}</p>
                        {% if booking_product.description != blank %}
                          <div class="gc-product-summary-description">{{ booking_product.description }}</div>
                        {% endif %}
                      </div>
                    {% endif %}
                    
                    <!-- Countdown Timer -->
                    <div id="gc-timer-container" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    <span id="gc-timer-text">Held for 20:00</span>
                    </div>

                    <!-- Status Message -->
                    <div class="gc-status-message"></div>

                    {% unless is_product_page %}
                      <!-- Product Toggle -->
                      <div class="gc-product-toggle-container" style="display: none;">
                          <div class="gc-product-toggle">
                              <!-- Pills injected by JS -->
                          </div>
                          <div class="gc-product-toggle-select-wrapper gc-select-wrapper">
                            <select class="gc-product-toggle-select gc-select" aria-label="Select a rentable product"></select>
                            <div class="gc-select-chevron">
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                              </svg>
                            </div>
                          </div>
                      </div>
                    {% endunless %}

                    <!-- Date Range Validation -->
                    <div class="gc-input-group">
                    <label class="gc-label">Rental Dates</label>
                    <div class="gc-date-range">
                        <div class="gc-input-wrapper">
                        <div class="gc-input-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="icon-calendar" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <input type="text" name="booking_start_date" class="gc-input" placeholder="Start Date" required readonly>
                        </div>
                        <div class="gc-input-wrapper">
                        <div class="gc-input-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="icon-calendar" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <input type="text" name="booking_end_date" class="gc-input" placeholder="End Date" required readonly>
                        </div>
                    </div>
                    </div>

                    <div class="gc-form-row gc-location-quantity-row">
                        <!-- Location -->
                        <div class="gc-input-group gc-location-group">
                            <label class="gc-label">Location</label>
                            <div class="gc-input-wrapper gc-select-wrapper">
                                <div class="gc-input-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                </div>
                                <select name="booking_location" class="gc-select" required>
                                <option value="" disabled selected>Select a location</option>
                                </select>
                                <div class="gc-select-chevron">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="gc-input-group gc-quantity-group">
                            <label class="gc-label">Quantity</label>
                            <div class="gc-quantity-wrapper">
                                <button type="button" class="gc-qty-btn gc-qty-minus" aria-label="Decrease quantity">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                                <input type="number" name="booking_quantity" class="gc-input gc-qty-input" value="1" min="1" max="10" required readonly>
                                <button type="button" class="gc-qty-btn gc-qty-plus" aria-label="Increase quantity">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Fulfillment Type -->
                    <div class="gc-input-group gc-fulfillment-group">
                        <label class="gc-label">Fulfillment Options</label>
                        <div class="gc-fulfillment-select-wrapper gc-select-wrapper">
                            <select class="gc-fulfillment-select gc-select" name="fulfillment_type_mobile" aria-label="Select fulfillment option">
                                <option value="pickup" selected>Pick Up</option>
                                <option value="delivery">Drop Off (Delivery)</option>
                            </select>
                            <div class="gc-select-chevron">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="gc-fulfillment-options">
                            <label class="gc-radio-label">
                                <input type="radio" name="fulfillment_type" value="pickup" checked>
                                <span class="gc-radio-text">Pick Up</span>
                            </label>
                            <label class="gc-radio-label">
                                <input type="radio" name="fulfillment_type" value="delivery">
                                <span class="gc-radio-text">Drop Off (Delivery)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Dynamic Details -->
                    <div class="gc-dynamic-details">
                        <!-- Pickup Address (Shows when Pickup selected) -->
                        <div class="gc-pickup-details" style="display: block;">
                            <div class="gc-input-wrapper gc-pickup-display">
                                <div class="gc-input-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                </div>
                                <span class="gc-address-text">Pick-up my cart at The Dock Sayulita</span>
                            </div>
                        </div>

                        <!-- Delivery Address (Shows when Delivery selected) -->
                        <div class="gc-delivery-details" style="display: none;">
                            <div class="gc-input-wrapper">
                                <div class="gc-input-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                </div>
                                <input type="text" name="delivery_address" class="gc-input" placeholder="Enter full delivery address">
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <button type="submit" class="gc-submit-btn">
                    {{ block.settings.button_text | default: "Book Now" }}
                    </button>

                </div>
                </form>
            </div>
        </div>
      </div>

    </div>
  </div>
</section>

{% schema %}
{
  "name": "Booking Widget (v2)",
  "target": "section",
  "stylesheet": "booking-widget.css",
  "javascript": "booking-widget.js",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Get Your Golf Cart Reserved in 4 Simple Steps"
    },
    {
       "type": "product",
       "id": "product",
       "label": "Product to Rent"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Book Now"
    }
  ]
}
{% endschema %}
